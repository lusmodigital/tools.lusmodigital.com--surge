<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Blog Lister HTML</title>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/themes/prism.min.css"
    />
  </head>
  <body>
    <div class="my-5" style="margin-left: 20rem; margin-right: 20rem">
      <h1>Blog Lister HTML</h1>
      <form class="form-inline">
        <div class="form-group">
            <input class="form-control mr-3" placeholder="URL Blog List Container" type="text" id="url-template" value="">
        </div>
        <button type="button" class="btn btn-primary" id="getDataBtn">Fetch!</button>
      </form>
        <div class="form-group">
          <label for="html-input">Masukkan Template HTML:</label>
          <textarea
            id="html-input"
            name="html-input"
            class="form-control"
            rows="10"
          ></textarea>
        </div>
      <form class="form-inline mb-2">
        <div class="form-group">
            <input class="form-control mr-3" placeholder="URL Artikel" type="text" id="url-artikel" value="">
        </div>
        <button type="button" class="btn btn-primary" id="getArtikelBtn">Get!</button>
      </form>
        <div id="meta-title-container">
          <!-- HTML forms -->
          <form id="blogForm">
            <label for="title">Title:</label>
            <input class="form-control mr-3" type="text" id="title" required><br>

            <label for="permalink">Permalink:</label>
            <input class="form-control mr-3" type="text" id="permalink" required><br>

            <label for="imageSrc">Image Source:</label>
            <input class="form-control mr-3" type="text" id="imageSrc" required><br>

            <label for="author">Author:</label>
            <input class="form-control mr-3" type="text" id="author" required><br>

            <label for="author">Author Image Source:</label>
            <input class="form-control mr-3" type="text" id="authorImageSrc" required><br>

            <label for="date">Date:</label>
            <input class="form-control mr-3" type="text" id="date" required><br>

            <label for="category">Category:</label>
            <input class="form-control mr-3" type="text" id="category" required><br>

            <label for="excerpt">Excerpt:</label>
            <textarea class="form-control mr-3" id="excerpt" required></textarea><br>

            <button type="button" class="btn btn-primary" id="addBlog">Add Blog to List!</button>
          </form>

          <!-- Blog List Container -->
          <div id="blogList"></div>
        <div class="d-flex justify-content-end">
          <button
            type="button"
            id="update-html-btn"
            class="btn btn-primary float-end"
            style="display: none"
          >
            Update HTML
          </button>
        </div>
      <div class="alert-container"></div>
      <div id="modalTunggu" class="modal" tabindex="-1" role="dialog">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Mohon Tunggu!</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <p>Sistem sedang memproses fetch dengan bypass policy CORS server URL yang diberikan. Proses ini berlangsung sekitar 30 detik-1 menit.</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" aria-hidden="true">Baik</button>
              </div>
            </div>
          </div>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/components/prism-html.min.js"></script>
    <script>
      const htmlInput = document.getElementById("html-input");
      function addBlogList(newBlogPost) {
        const htmlText = htmlInput.value;
        const parser = new DOMParser();
        const htmlDocument = parser.parseFromString(htmlText, "text/html");

        const blogListContainer = htmlDocument.querySelector(".tpg-even");
        console.log("dari", blogListContainer)
        // TODO: Add 
        $(blogListContainer).prepend(newBlogPost);
        console.log("jadi", blogListContainer)
        htmlInput.value = htmlDocument.documentElement.outerHTML;
      }
      function createBlogPost(data) {
        const postContainer = document.createElement('div');
        postContainer.setAttribute('class', 'rt-col-md-12 rt-col-sm-12 rt-col-xs-12 img_zoom_out rt-list-item rt-grid-item');
        postContainer.setAttribute('data-id', data.id);
      
        const holder = document.createElement('div');
        holder.setAttribute('class', 'rt-holder tpg-post-holder');
      
        const detail = document.createElement('div');
        detail.setAttribute('class', 'rt-detail rt-el-content-wrapper');
      
        const imageHolder = document.createElement('div');
        imageHolder.setAttribute('class', 'rt-img-holder tpg-el-image-wrap has-thumbnail');
      
        const imageLink = document.createElement('a');
        imageLink.setAttribute('data-id', data.id);
        imageLink.setAttribute('href', data.imageLink);
        imageLink.setAttribute('class', 'tpg-post-link');
        imageLink.setAttribute('target', '_self');
      
        const image = document.createElement('img');
        image.setAttribute('decoding', 'async');
        image.setAttribute('src', data.imageSrc);
        image.setAttribute('class', 'rt-img-responsive');
        image.setAttribute('width', data.imageWidth);
        image.setAttribute('height', data.imageHeight);
        image.setAttribute('alt', data.imageAlt);
      
        const overlay = document.createElement('div');
        overlay.setAttribute('class', 'overlay grid-hover-content');
      
        imageLink.appendChild(image);
        imageHolder.appendChild(imageLink);
        imageHolder.appendChild(overlay);
      
        const postRightContent = document.createElement('div');
        postRightContent.setAttribute('class', 'post-right-content');
      
        const entryTitleWrapper = document.createElement('div');
        entryTitleWrapper.setAttribute('class', 'entry-title-wrapper');
      
        const entryTitle = document.createElement('h4');
        entryTitle.setAttribute('class', 'entry-title');
      
        const postLink = document.createElement('a');
        postLink.setAttribute('data-id', data.id);
        postLink.setAttribute('href', data.postLink);
        postLink.setAttribute('class', 'tpg-post-link');
        postLink.setAttribute('target', '_self');
        postLink.textContent = data.postTitle;
      
        entryTitle.appendChild(postLink);
        entryTitleWrapper.appendChild(entryTitle);
        postRightContent.appendChild(entryTitleWrapper);
      
        const postMetaTags = document.createElement('div');
        postMetaTags.setAttribute('class', 'post-meta-tags rt-el-post-meta');
      
        const authorSpan = document.createElement('span');
        authorSpan.setAttribute('class', 'author has-author-avatar');
      
        const authorImage = document.createElement('img');
        authorImage.setAttribute('alt', '');
        authorImage.setAttribute('src', data.authorImageSrc);
        authorImage.setAttribute('class', 'avatar avatar-80 photo');
        authorImage.setAttribute('height', data.authorImageHeight);
        authorImage.setAttribute('width', data.authorImageWidth);
      
        const authorLink = document.createElement('a');
        authorLink.setAttribute('href', data.authorLink);
        authorLink.textContent = data.authorName;
      
        authorSpan.appendChild(authorImage);
        authorSpan.appendChild(authorLink);
      
        const dateSpan = document.createElement('span');
        dateSpan.setAttribute('class', 'date');
      
        const calendarIcon = document.createElement('i');
        calendarIcon.setAttribute('aria-hidden', 'true');
        calendarIcon.setAttribute('class', 'far fa-calendar-alt');
      
        const dateLink = document.createElement('a');
        dateLink.setAttribute('href', data.dateLink);
        dateLink.textContent = data.date;
      
        dateSpan.appendChild(calendarIcon);
        dateSpan.appendChild(dateLink);
      
        const categoriesSpan = document.createElement('span');
        categoriesSpan.setAttribute('class', 'categories-links');
      
        const folderIcon = document.createElement('i');
        folderIcon.setAttribute('aria-hidden', 'true');
        folderIcon.setAttribute('class', 'fas fa-folder-open');
      
        const categoryLink = document.createElement('a');
        categoryLink.setAttribute('class', data.categoryClass);
        categoryLink.setAttribute('href', data.categoryLink);
        categoryLink.textContent = data.category;
      
        categoriesSpan.appendChild(folderIcon);
        categoriesSpan.appendChild(categoryLink);
      
        postMetaTags.appendChild(authorSpan);
        postMetaTags.appendChild(dateSpan);
        postMetaTags.appendChild(categoriesSpan);

        postRightContent.appendChild(postMetaTags);
      
        const tpgExcerpt = document.createElement('div');
        tpgExcerpt.setAttribute('class', 'tpg-excerpt tpg-el-excerpt');
      
        const tpgExcerptInner = document.createElement('div');
        tpgExcerptInner.setAttribute('class', 'tpg-excerpt-inner');
        tpgExcerptInner.textContent = data.excerpt;
      
        tpgExcerpt.appendChild(tpgExcerptInner);
        postRightContent.appendChild(tpgExcerpt);
      
        const postFooter = document.createElement('div');
        postFooter.setAttribute('class', 'post-footer');
      
        const readMore = document.createElement('div');
        readMore.setAttribute('class', 'read-more');
      
        const readMoreLink = document.createElement('a');
        readMoreLink.setAttribute('data-id', data.id);
        readMoreLink.setAttribute('href', data.readMoreLink);
        readMoreLink.setAttribute('class', 'tpg-post-link');
        readMoreLink.setAttribute('target', '_self');
        readMoreLink.textContent = 'Read More';
      
        readMore.appendChild(readMoreLink);
      
        postFooter.appendChild(readMore);

        postRightContent.appendChild(postFooter);
      
        detail.appendChild(imageHolder);
        detail.appendChild(postRightContent);
      
        holder.appendChild(detail);
        postContainer.appendChild(holder);

        console.log(postContainer);
        addBlogList(postContainer.outerHTML)
      
        return postContainer;
      }
      $(document).ready(function() {
        // Handle "Add Blog" form submission
        document.querySelector("#addBlog").addEventListener("click", () => {         
          var title = $('#title').val();
          var permalink = $('#permalink').val();
          var imageSrc = $('#imageSrc').val();
          var authorImageSrc = $('#authorImageSrc').val();
          var author = $('#author').val();
          var date = $('#date').val();
          var category = $('#category').val();
          var excerpt = $('#excerpt').val();
    
          var blogPostData = {
            id: (Math.floor(Math.random() * 10000) + 1).toString(), // Assign a unique ID for the blog post
            postTitle: title,
            postLink: permalink,
            imageSrc: imageSrc,
            authorImageSrc: authorImageSrc,
            authorName: author,
            date: date,
            category: category,
            excerpt: excerpt
          };
          console.log(blogPostData);
    
          var blogPost = createBlogPost(blogPostData);
          $('#blogList').append(blogPost);
    
          // Clear form fields
          // $('#blogForm')[0].reset();
        });
      });
    </script>
    <script>
      $(document).ready(function() {
        $('#canonical-url').on('input', function() {
          var permalink = $(this).val();
      
          // Replace multiple spaces with a single space
          permalink = permalink.replace(/\s+/g, ' ');
      
          // Convert to lowercase
          permalink = permalink.toLowerCase();
      
          // Replace non-alphanumeric characters with spaces
          permalink = permalink.replace(/\W/g, ' ');
          
          // Replace spaces with dashes
          permalink = permalink.replace(/\s+/g, '-');
      
          // Update the value of the input field
          $(this).val(permalink);
        });
      });
      function GetDataCORSBypass(urlArtikel) {
        try {
            $.getJSON('http://api.allorigins.win/get?url='+encodeURIComponent(urlArtikel)+'&callback=?', function (data) {
                const parser = new DOMParser();
                const htmlDoc = parser.parseFromString(data.contents, 'text/html');
                console.log(htmlDoc)
                $('#html-input').val(data.contents)
                // changeForm()
            });
            $('#modalTunggu').modal('show');
            console.log("Sedang memproses fetch dengan bypass policy CORS server URL yang diberikan. Proses ini berlangsung sekitar 30 detik - 1 menit.")
        } catch(err) {
            console.log(err);
            alert("Error! Pastikan url benar dan konten dalam page berbasis Wordpress Article!")
        }
      }
      
      function checkAccessControlAllowOrigin(url) {
        var xhr = new XMLHttpRequest();
        xhr.open('HEAD', url, false);
        try {
          xhr.send();
        } catch (e) {
          console.log('AccessControlAllowOrigin tidak diizinkan!');
        }
        let check = false;
        try {
          if (xhr.getAllResponseHeaders() != '') check = true;
          if (xhr.getAllResponseHeaders().indexOf("Access-Control-Allow-Origin") >= 0)
              check = true;
          console.log("check")
          console.log('"'+xhr.getAllResponseHeaders()+'"')
        } catch (e) {console.log(e)}
        console.log(check)
        return check;
      }

      document.querySelector("#getArtikelBtn").addEventListener('click', GetArtikel);
      document.querySelector("#getDataBtn").addEventListener('click', GetData);
      function GetArtikel()  {
        const xhr = new XMLHttpRequest;
        let urlArtikel = $("#url-artikel").val();
        let cek = checkAccessControlAllowOrigin(urlArtikel);
        if (cek) {
            xhr.open("GET", urlArtikel);
            xhr.responseType = 'document';
            xhr.onload = () => {
                if (xhr.readyState === xhr.DONE && xhr.status === 200) {
                    try {
                        var XMLResult = xhr.responseXML;
                        console.log(XMLResult);
                        var serializer = new XMLSerializer();
                        var htmlString = serializer.serializeToString(XMLResult);
                        const parser = new DOMParser();
                        const htmlDocument = parser.parseFromString(htmlString, "text/html");

                        // Fetch Title
                        const entryTitleInput = document.getElementById("title");
                        const entryTitleElement = htmlDocument.querySelector(
                          'h1[class="entry-title"]'
                        );
                        if (entryTitleElement) {
                          entryTitleInput.value = entryTitleElement.innerText
                            .replace(/\s+/g, " ")
                            .trim();
                          entryTitleElement.innerText = entryTitleInput.value;
                        }

                        // Fetch Permalink
                        const permalinkInput = document.getElementById("permalink");
                        const canonicalElement = htmlDocument.querySelector(
                          'head link[rel="canonical"]'
                        );
                        if (canonicalElement) {
                          permalinkInput.value = canonicalElement.getAttribute("href");
                          canonicalElement.setAttribute("href", permalinkInput.value);
                          const ogUrlElement = htmlDocument.querySelector(
                            'meta[property="og:url"]'
                          );
                          if (ogUrlElement) {
                            ogUrlElement.setAttribute("content", permalinkInput.value);
                          }
                        }
                        console.log(entryTitleElement.innerText, permalinkInput.value);
                    } catch(err) {
                        try {
                            GetDataCORSBypass(urlArtikel)
                        } catch(err) {
                            alert("Error! Pastikan url benar dan konten dalam page berbasis Wordpress Article!")
                        }
                    }
                }
            };
    
            xhr.send();
        } else {
            GetDataCORSBypass(urlArtikel)
        }
      }
      function GetData()  {
        const xhr = new XMLHttpRequest;
        let urlBlogList = $("#url-template").val();
        let cek = checkAccessControlAllowOrigin(urlBlogList);
        if (cek) {
            xhr.open("GET", urlBlogList);
            xhr.responseType = 'document';
            xhr.onload = () => {
                if (xhr.readyState === xhr.DONE && xhr.status === 200) {
                    try {
                        var XMLResult = xhr.responseXML;
                        console.log(XMLResult);
                        var serializer = new XMLSerializer();
                        var htmlString = serializer.serializeToString(XMLResult);
                        $('#html-input').val(htmlString);
                        changeForm()
                    } catch(err) {
                        try {
                            GetDataCORSBypass(urlBlogList)
                        } catch(err) {
                            alert("Error! Pastikan url benar dan konten dalam page berbasis Wordpress Article!")
                        }
                    }
                }
            };
    
            xhr.send();
        } else {
            GetDataCORSBypass(urlBlogList)
        }
      }
    </script>
  </body>
</html>
